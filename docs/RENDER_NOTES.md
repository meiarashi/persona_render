# Render デプロイ時の注意事項

## 静的ファイルの配信

Renderでは、FastAPIアプリケーションが静的ファイル（画像、CSS、JS）を直接配信します。
以下の点に注意してください：

### 画像ファイル

1. **配置場所**: `/images/`ディレクトリ（プロジェクトルート）
2. **ファイル名**: 日本語ファイル名は使用可能ですが、URLエンコードされます
3. **アクセスパス**: `https://your-app.onrender.com/images/ファイル名.png`

### ディレクトリ構造

```
persona_render/
├── images/           # すべての画像ファイル（レガシー配置）
│   ├── owl.png
│   ├── 内科.png
│   ├── 外科.png
│   └── ...
├── assets/
│   ├── fonts/        # フォントファイル
│   │   └── ipaexg.ttf
│   └── images/       # 画像ファイル（新配置、現在未使用）
├── frontend/
│   ├── user/        # ユーザー画面のHTML/CSS/JS
│   └── admin/       # 管理画面のHTML/CSS/JS
└── backend/         # FastAPIアプリケーション
    ├── api/          # APIルーター
    ├── models/       # データモデル
    ├── services/     # ビジネスロジック
    ├── config/       # 設定ファイル
    └── utils/        # ユーティリティ
```

## パフォーマンスの最適化

### 1. 画像の最適化

デプロイ前に画像を最適化することを推奨：

```bash
# PNG画像の最適化（optipngが必要）
find images -name "*.png" -exec optipng -o7 {} \;

# またはオンラインツールを使用
# - TinyPNG: https://tinypng.com/
# - Squoosh: https://squoosh.app/
```

### 2. 起動時間の短縮

Renderの無料プランでは、15分間アクセスがないとスリープ状態になります。
起動時間を短縮するために：

- 不要な依存関係を削除
- requirements.txtを最小限に保つ
- 重い処理は遅延読み込みにする

### 3. タイムアウト設定

`render.yaml`で設定済み：
```yaml
startCommand: ... --timeout 120
```

これにより、AI処理に時間がかかってもタイムアウトしにくくなります。

## データの永続化

### 永続ディスクの使用

- **パス**: `/var/app_settings`
- **用途**: 
  - RAGデータベース（SQLite）
  - アップロードされたCSVファイル
  - 管理設定

### バックアップ

永続ディスクのデータは定期的にバックアップすることを推奨：

1. 管理画面からRAGデータをエクスポート
2. ローカルに保存
3. 必要に応じて再アップロード

## トラブルシューティング

### よくある問題

1. **画像が404エラー**
   - ファイル名の大文字小文字を確認
   - imagesディレクトリの存在を確認
   - Renderのログでマウントパスを確認

2. **AI生成が遅い**
   - 無料プランのリソース制限
   - より軽量なモデル（GPT-3.5-turbo）を使用
   - タイムアウト値を増やす

3. **メモリ不足エラー**
   - 大きなファイルのアップロードを避ける
   - バッチ処理のサイズを小さくする
   - 有料プランへのアップグレードを検討

### ログの確認方法

1. Renderダッシュボードにログイン
2. サービスを選択
3. 「Logs」タブをクリック
4. リアルタイムログまたは過去のログを確認

### デバッグモード

開発時は以下の環境変数を追加：
```
DEBUG=true
PYTHONUNBUFFERED=1
```

## セキュリティ

### 推奨事項

1. **APIキーの管理**
   - 環境変数で管理（コードに含めない）
   - 定期的にローテーション
   - 最小権限の原則

2. **アクセス制限**
   - 管理画面へのアクセス制限を検討
   - CloudflareなどのWAFを使用
   - IPホワイトリストの設定

3. **HTTPS**
   - Renderは自動的にHTTPSを提供
   - カスタムドメインもHTTPS対応

## アップグレード

### 無料プランの制限

- RAM: 512MB
- CPU: 共有
- ディスク: 1GB（永続ディスク）
- スリープ: 15分間非アクティブ後

### 有料プランのメリット

- より多くのRAM/CPU
- 常時稼働（スリープなし）
- より大きな永続ディスク
- 優先サポート

プロダクション環境では有料プランを推奨します。