# ペルソナ生成システム 引き継ぎ資料

## 📋 目次
1. [システム概要](#システム概要)
2. [必要なAPIキーと取得方法](#必要なapiキーと取得方法)
3. [Render.com環境変数設定](#rendercom環境変数設定)
4. [デプロイ手順](#デプロイ手順)
5. [動作確認チェックリスト](#動作確認チェックリスト)
6. [トラブルシューティング](#トラブルシューティング)
7. [メンテナンス情報](#メンテナンス情報)

---

## システム概要

### 機能一覧
- **診療科別ペルソナ生成**: 医科19科、歯科5科、その他6科の計30診療科対応
- **主訴別ペルソナ作成**: 各診療科の主訴に基づくリアルなペルソナ生成
- **タイムライン分析**: 検索キーワードの時系列分析とビジュアライゼーション
- **競合分析**: Google Maps APIを使用した地域競合分析とSWOT分析
- **マルチAI対応**: GPT-4o、Claude 3.5 Sonnet、Gemini Pro対応
- **エクスポート機能**: PDF、PowerPoint形式でのダウンロード

### アクセス制御
4つの部門別アクセス制御（Basic認証）
- `/medical`: 医科部門
- `/dental`: 歯科部門
- `/others`: その他診療科部門
- `/admin`: 管理者画面

---

## 必要なAPIキーと取得方法

### 1. OpenAI API Key（必須）
**用途**: GPT-5を使用したペルソナ生成、分析

**取得手順**:
1. [OpenAI Platform](https://platform.openai.com/)にアクセス
2. アカウント作成またはログイン
3. 左メニューの「API Keys」をクリック
4. 「Create new secret key」をクリック
5. キーをコピーして安全に保管（再表示不可）

### 2. Anthropic API Key（必須）
**用途**: Claude Sonnet 4を使用したペルソナ生成、分析

**取得手順**:
1. [Anthropic Console](https://console.anthropic.com/)にアクセス
2. アカウント作成（審査あり、1-2営業日）
3. 「API Keys」セクションへ移動
4. 「Create Key」をクリック
5. キーをコピーして保管

### 3. Google API Keys（2つ必要）

#### 3-1. Google AI Studio API Key（Gemini用）
**用途**: Gemini Proを使用したペルソナ生成

**取得手順**:
1. [Google AI Studio](https://makersuite.google.com/)にアクセス
2. Googleアカウントでログイン
3. 「Get API Key」をクリック
4. 新規プロジェクトまたは既存プロジェクトを選択
5. APIキーを生成してコピー

#### 3-2. Google Maps API Key
**用途**: 競合分析機能での地図表示、施設検索

**取得手順**:
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを作成または選択
3. 「APIとサービス」→「認証情報」→「認証情報を作成」→「APIキー」
4. 必要なAPIを有効化:
   - Maps JavaScript API
   - Places API
   - Geocoding API
5. APIキーに制限を設定（推奨）:
   - HTTPリファラー制限: `https://your-app.onrender.com/*`
   - API制限: 上記3つのAPIのみ

**料金目安**:
- 月間$200分の無料クレジット付き
- 競合分析1回あたり約$0.02-0.05

### 4. SerpAPI Key（オプション - 将来実装予定）
**用途**: Web検索による競合施設の詳細情報取得（現在未使用・実装済み）

**取得手順**:
1. [SerpAPI](https://serpapi.com/)にアクセス
2. アカウント作成（無料プランあり）
3. ダッシュボードから「API Key」を確認
4. キーをコピー

**料金**:
- 無料プラン: 100検索/月
- 有料プラン: $50〜/月

**注意**:
- **現在はコメントアウトされており使用されていません**
- コード内に実装は完了しているため、将来的に有効化可能
- 設定しなくても競合分析は問題なく動作します

### 5. e-Stat API Key（オプション - 地域統計データ用）
**用途**: 政府統計データを使用した地域分析

**取得手順**:
1. [e-Stat](https://www.e-stat.go.jp/)にアクセス
2. 「API」→「利用登録」
3. 必要事項を入力して申請
4. メールでAPIキーを受領（即日〜数日）

**料金**: 無料

**注意**: 設定しない場合はデフォルトの地域データを使用

### 6. 認証用パスワード（必須）
以下の6つのパスワードを設定:
- `ADMIN_USERNAME`: admin（固定）
- `ADMIN_PASSWORD`: 管理者パスワード（任意設定）
- `MEDICAL_USERNAME`: medical（固定）
- `MEDICAL_PASSWORD`: 医科部門パスワード（任意設定）
- `DENTAL_USERNAME`: dental（固定）
- `DENTAL_PASSWORD`: 歯科部門パスワード（任意設定）
- `OTHERS_USERNAME`: others（固定）
- `OTHERS_PASSWORD`: その他部門パスワード（任意設定）
- `USER_USERNAME`: user（固定）
- `USER_PASSWORD`: 一般ユーザーパスワード（任意設定）

---

## Render.com環境変数設定

### 設定手順

1. **Render.comダッシュボード**にログイン
2. 該当するWebサービスを選択
3. 左メニューの「Environment」をクリック
4. 以下の環境変数を追加:

### 環境変数リスト

```bash
# AI API Keys（必須）
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxx
GOOGLE_API_KEY=AIzaxxxxxxxxxxxxxxxxxxxxx

# Google Maps API（競合分析用）
GOOGLE_MAPS_API_KEY=AIzaxxxxxxxxxxxxxxxxxxxxx

# オプションAPI（競合分析強化用）
SERPAPI_KEY=xxxxxxxxxxxxxxxxxxxxxxxx  # Web検索による詳細情報取得（オプション）
ESTAT_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxx  # 政府統計データ取得（オプション）

# 認証情報（必須）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-admin-password
MEDICAL_USERNAME=medical
MEDICAL_PASSWORD=your-secure-medical-password
DENTAL_USERNAME=dental
DENTAL_PASSWORD=your-secure-dental-password
OTHERS_USERNAME=others
OTHERS_PASSWORD=your-secure-others-password
USER_USERNAME=user
USER_PASSWORD=your-secure-user-password

# オプション（デフォルト値あり）
PORT=10000
PYTHONUNBUFFERED=1
```

---

## デプロイ手順

### 1. GitHubリポジトリの準備

```bash
# ローカルでの最終確認
git status
git add -A
git commit -m "Production ready deployment"
git push origin main
```

### 2. Render.comでのデプロイ

#### 初回デプロイの場合:
1. Render.comダッシュボードで「New +」→「Web Service」
2. GitHubリポジトリを接続
3. 設定:
   - **Name**: persona-generator-prod
   - **Branch**: main
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `uvicorn backend.main:app --host 0.0.0.0 --port $PORT`
4. 環境変数を設定（上記参照）
5. 「Create Web Service」をクリック

#### 更新デプロイの場合:
1. GitHubにpushすると自動デプロイ
2. または「Manual Deploy」→「Deploy latest commit」

### 3. ビルドログの確認

デプロイ中は必ずログを確認:
- 正常: "Your service is live"メッセージ
- エラー時: 赤色のエラーメッセージを確認

---

## 動作確認チェックリスト

### 🔍 基本機能確認

#### 1. アクセス確認
- [ ] `/` - トップページ表示
- [ ] `/medical` - 医科部門（Basic認証）
- [ ] `/dental` - 歯科部門（Basic認証）
- [ ] `/others` - その他部門（Basic認証）
- [ ] `/admin` - 管理者画面（Basic認証）

#### 2. ペルソナ生成機能
- [ ] 診療科選択が正常に動作
- [ ] 主訴リストが表示される
- [ ] ペルソナ生成
- [ ] PDF出力
- [ ] PowerPoint出力

#### 3. タイムライン分析
- [ ] CSVアップロード機能
- [ ] グラフ表示（散布図）
- [ ] ラベル表示（最大30個）
- [ ] AI分析レポート生成

#### 4. 競合分析
- [ ] 自院情報入力
- [ ] 競合施設の自動検出
- [ ] 地図表示
- [ ] SWOT分析生成
- [ ] PDFレポート出力

### 🔧 詳細確認項目

#### パフォーマンス
- [ ] ペルソナ生成時間: 10-15秒以内
- [ ] 主訴表示時間: 1秒以内（キャッシュ利用時）
- [ ] ページ読み込み: 3秒以内

#### レスポンシブ対応
- [ ] PC表示（1920x1080）
- [ ] タブレット表示（iPad）
- [ ] スマートフォン表示（iPhone/Android）

#### ブラウザ対応
- [ ] Chrome（推奨）
- [ ] Edge
- [ ] Safari
- [ ] Firefox

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. 500 Internal Server Error
**原因**: APIキーの設定ミス
**解決方法**:
- 環境変数を再確認
- APIキーの前後のスペースを削除
- Render.comを再デプロイ

#### 2. 認証ダイアログが繰り返し表示
**原因**: パスワード設定ミス
**解決方法**:
- 環境変数のUSERNAME/PASSWORDを確認
- ブラウザのキャッシュをクリア

#### 3. ペルソナ生成でエラー
**原因**: APIの利用制限または残高不足
**解決方法**:
- 各APIのダッシュボードで利用状況確認
- 残高追加またはレート制限待機

#### 4. 競合分析が動作しない
**原因**: Google Maps APIの設定不足
**解決方法**:
- Places API、Maps JavaScript APIが有効か確認
- APIキーの制限設定を確認
- ドメイン制限がRender.comのURLを含むか確認

#### 5. 主訴リストが表示されない
**原因**: キャッシュの問題
**解決方法**:
```javascript
// ブラウザコンソールで実行
localStorage.clear();
location.reload();
```

---

## メンテナンス情報

### 定期メンテナンス項目

#### 月次
- [ ] APIキー利用状況確認
- [ ] エラーログ確認
- [ ] パフォーマンス測定
- [ ] セキュリティアップデート確認

#### 四半期
- [ ] パスワード変更
- [ ] 依存パッケージ更新
- [ ] バックアップ確認

### データ更新

#### RAGデータ（検索キーワード）更新
1. 新しいCSVファイルを準備
2. `/rag/各診療科/{診療科名}/主訴/`に配置
3. サーバー再起動で自動読み込み

#### 主訴リスト更新
`backend/config/chief_complaints.json`を編集後、再デプロイ

### ログ確認

#### Render.comでのログ確認
1. Dashboardから該当サービス選択
2. 「Logs」タブをクリック
3. リアルタイムログまたは過去ログを確認

#### 重要なログパターン
- `INFO: Application startup complete` - 正常起動
- `ERROR:` - エラー発生
- `WARNING:` - 警告（要確認）

### バックアップ

#### 重要ファイル
- `/backend/config/` - 設定ファイル
- `/rag/` - RAGデータ
- `/frontend/` - フロントエンドコード

#### バックアップ方法
```bash
# ローカルにクローン
git clone https://github.com/your-repo/persona-generator.git

# 定期的にpull
git pull origin main
```

---

## サポート情報

### 技術仕様
- **Backend**: FastAPI (Python 3.11)
- **Frontend**: Vanilla JavaScript, Chart.js
- **Database**: SQLite（RAGデータ）
- **Cache**: In-memory + LocalStorage
- **Deployment**: Render.com

### 更新履歴
- 2024.12: 初回リリース
- 2024.12: タイムライン分析機能追加
- 2024.12: 競合分析機能追加
- 2024.12: キャッシュ最適化実装

### 既知の制限事項
- 同時アクセス数: 推奨50ユーザーまで
- ファイルアップロード: 最大10MB
- API制限: 各プロバイダーのレート制限に準拠

---

## 付録: コマンドリファレンス

### ローカル開発環境

```bash
# バックエンド起動
cd backend
python -m uvicorn main:app --reload --port 8000

# 環境変数設定（Windows）
set OPENAI_API_KEY=sk-xxxxx
set ADMIN_PASSWORD=password

# 環境変数設定（Mac/Linux）
export OPENAI_API_KEY=sk-xxxxx
export ADMIN_PASSWORD=password
```

### デバッグ用コマンド

```bash
# JavaScript構文チェック
node -c frontend/medical/persona/script.js

# Python構文チェック
python -m py_compile backend/main.py

# RAGデータ確認
python scripts/manage_rag_data.py status
```

### Git操作

```bash
# 変更を確認
git status
git diff

# コミット
git add -A
git commit -m "Update: description"
git push origin main

# ブランチ操作
git checkout -b feature/new-feature
git merge main
```

---

**最終更新日**: 2025年9月22日
**ドキュメントバージョン**: 1.0.0