# 医療系ペルソナ自動生成AI - フェーズ2改修要件 壁打ち

## プロジェクト概要
- **システム名**: 医療系ペルソナ自動生成AI
- **現在の状況**: フェーズ1納品済み、Renderでデプロイ中
- **目的**: クライアントからの改修要望をプロ目線でブラッシュアップし、要件定義を固める

## システムの現状整理
### 主要機能
1. **ペルソナ生成機能**
   - 複数AIモデル対応（GPT、Claude、Gemini）
   - 30診療科以上対応
   - 12種類の患者タイプ
   - RAGデータ活用
   - PDF/PPT出力

2. **管理機能**
   - AIモデル選択
   - 文字数制限調整
   - RAGデータ管理
   - Basic認証

### 技術スタック
- Backend: FastAPI (Python)
- Frontend: Vanilla JavaScript
- Database: SQLite (RAGデータ)
- Hosting: Render.com

---

## クライアント要望のヒアリング＆ブラッシュアップ

### 要望1: 診療科別アクセス制御（医科・歯科・その他）
**クライアントからの要望（原文）**:
> 現在すべての診療科が表示されるトップページは残しつつ、医師の属性に合わせて「医科」「歯科」「それ以外の科」のみが表示され選択可能なサブページを別途用意したい。管理者は従来通りアクセスし、各医師には専用URLを伝えて利用してもらう。

**現状の課題分析**:
- 全30診療科が一覧表示されると、医師にとって不要な選択肢が多く使いづらい
- 歯科医が内科などの医科系ペルソナを生成する必要性は低い
- 専門外の診療科を選択してしまうリスクがある

**プロ目線でのブラッシュアップ**:
1. **診療科の分類定義を明確化**
   - 医科: 内科系・外科系・専門科（精神科、皮膚科等）
   - 歯科: 一般歯科、小児歯科、矯正歯科、審美歯科、口腔外科
   - その他: 麻酔科、放射線科、リハビリテーション科など
2. **URLパラメータベースの実装**を推奨
   - `/medical` - 医科専用
   - `/dental` - 歯科専用  
   - `/others` - その他専用
   - `/` - 全科表示（管理者・既存）
3. **セキュリティ強化**
   - URLを知っていても不正アクセスできないよう、簡易的なアクセストークンの実装
   - アクセスログの記録

**技術的実現方法の提案**:
1. **ルーティング追加**
   - FastAPIに新規エンドポイント追加（`/medical`、`/dental`、`/others`）
   - 各エンドポイントで表示する診療科をフィルタリング
2. **フロントエンド改修**
   - URLパラメータを読み取り、対応する診療科のみ表示
   - 共通コンポーネント化して再利用性を高める
3. **設定ファイル拡張**
   - `departments.json`に`category`フィールド追加（medical/dental/others）
   - 管理画面から診療科カテゴリを変更可能に

**想定工数**:
- バックエンド改修: 8時間
- フロントエンド改修: 12時間  
- テスト・デバッグ: 4時間
- **合計: 24時間（3営業日）**

**リスク・懸念事項**:
- URLが流出した場合のアクセス制御（要検討）
- 診療科の分類で迷うケース（口腔外科は歯科？医科？）
- 将来的な診療科追加時の分類ルール策定が必要

**補足：診療科の分類案**

現在の30診療科を以下のように分類：

**医科（22科）**
- 内科系: 内科、循環器内科、消化器内科、呼吸器内科、糖尿病内科、腎臓内科、神経内科、内分泌科、血液内科
- 外科系: 外科、整形外科、脳神経外科、形成外科、美容外科
- 専門科: 小児科、皮膚科、眼科、精神科、耳鼻咽喉科、婦人科、泌尿器科、アレルギー科

**歯科（5科）**
- 一般歯科、小児歯科、矯正歯科、審美歯科、口腔外科

**その他（3科）**
- 麻酔科、放射線科、リハビリテーション科

**実装の代替案**
1. **クエリパラメータ方式**: `/?category=dental` のような形式
2. **サブドメイン方式**: `dental.persona-render.onrender.com`
3. **Basic認証併用**: 各カテゴリ用のユーザー名・パスワード設定

---

### 確定した実装方針

**実装方式**: URLパス方式で確定
- `/medical` - 医科専用
- `/dental` - 歯科専用
- `/others` - その他専用

**認証方式**: 各専用ページ用のBasic認証
- 環境変数で各ページ用のID/PASSを設定
  - `MEDICAL_USERNAME` / `MEDICAL_PASSWORD`
  - `DENTAL_USERNAME` / `DENTAL_PASSWORD`
  - `OTHERS_USERNAME` / `OTHERS_PASSWORD`

**診療科の振り分け（バランス調整案）**

```
【医科】18科
├─ 内科系（9科）
│  ├─ 内科
│  ├─ 循環器内科
│  ├─ 消化器内科
│  ├─ 呼吸器内科
│  ├─ 糖尿病内科
│  ├─ 腎臓内科
│  ├─ 神経内科
│  ├─ 内分泌科
│  └─ 血液内科
│
├─ 外科系（3科）
│  ├─ 外科
│  ├─ 整形外科
│  └─ 脳神経外科
│
└─ 主要診療科（6科）
   ├─ 小児科
   ├─ 皮膚科
   ├─ 眼科
   ├─ 耳鼻咽喉科
   ├─ 婦人科
   └─ 泌尿器科

【歯科】4科
├─ 一般歯科
├─ 小児歯科
├─ 矯正歯科
└─ 審美歯科

【その他（特殊・支援系）】8科
├─ 医療支援系（2科）
│  ├─ 麻酔科
│  └─ 放射線科
│
├─ 特殊診療科（3科）
│  ├─ 精神科
│  ├─ リハビリテーション科
│  └─ アレルギー科
│
├─ 境界領域（1科）
│  └─ 口腔外科
│
└─ 美容・形成系（2科）
   ├─ 形成外科
   └─ 美容外科
```

**バランス調整の根拠**:

1. **精神科を「その他」へ移動**
   - 一般的な身体診療とは異なる特殊性
   - 投薬管理とカウンセリングが主体
   - ペルソナ生成のアプローチも他科と異なる

2. **形成外科・美容外科を「その他」へ移動**
   - 自費診療が多く、一般医療とは異なるマーケティング
   - 美容目的の患者が多い特殊領域
   - ペルソナも「患者」より「顧客」に近い

3. **アレルギー科を「その他」へ移動**
   - 複数科にまたがる横断的な診療科
   - 単独標榜することが少ない
   - 内科や小児科と併設が多い

4. **リハビリテーション科を「その他」へ**
   - 急性期治療後のフォローが主
   - チーム医療の色が強い
   - 他科からの紹介患者が多い

5. **口腔外科を「その他」へ移動**
   - 歯科医師・医師の両方が標榜可能な境界領域
   - 顎顔面外傷、口腔がんなど医科的な手術も多い
   - 大学病院では医学部に所属することも多い

**最終的なバランス**:
- 医科: 18科（60%）- 一般的な診療科
- 歯科: 4科（13%）- 純粋な歯科診療
- その他: 8科（27%）- 特殊・支援・境界系

---

### 要望2: 主訴別RAGデータによるペルソナ精度向上
**クライアントからの要望（原文）**:
> 各科ごとにどういった症状で病院に来院するか選択できるようにして、さらにRAGを追加することで、「どの科」（RAG実装済み）の「どの主訴で」（フェーズ２でRAG実装）を選択できるようにする。科を選んだ後、「ペルソナを作成する目的」へ移行する前に「ペルソナの来院目的は」みたいな感じを出して選択できるようにする。

**現状の課題分析**:
- 現在は診療科単位でのRAGデータのみで、症状別の細かな対応ができない
- 例えば「内科」でも「発熱」「腹痛」「頭痛」では患者層が異なる
- ペルソナの具体性・リアリティが不足している可能性

**プロ目線でのブラッシュアップ**:
1. **フォームフローの改善**
   - 現在: 診療科 → 作成目的 → 患者タイプ → 人数
   - 改善: 診療科 → **主訴選択** → 作成目的 → 患者タイプ → 人数
2. **主訴の設計**
   - 各診療科ごとに代表的な主訴を5-10個程度用意
   - 「その他」オプションも追加（自由記述可能）
3. **2層構造のRAGデータ**
   - 第1層: 診療科別RAG（既存）
   - 第2層: 主訴別RAG（新規）
   - AIへのコンテキストで両方を組み合わせて使用

**技術的実現方法の提案**:
1. **データ構造の拡張**
   ```json
   // chief_complaints.json（新規）
   {
     "internal_medicine": [
       {"id": "fever", "name": "発熱", "description": "38度以上の発熱"},
       {"id": "abdominal_pain", "name": "腹痛", "description": "急性・慢性の腹痛"},
       {"id": "headache", "name": "頭痛", "description": "偏頭痛、緊張型頭痛"}
     ]
   }
   ```
2. **RAGデータ管理の拡張**
   - 既存: `department_id` のみでRAGデータを管理
   - 新規: `department_id` + `chief_complaint_id` の組み合わせで管理
3. **管理画面の機能追加**
   - 主訴別RAGデータのアップロード機能
   - 診療科と主訴の組み合わせでデータ管理

**セキュリティ面での重要な変更提案**:
クライアントの要望により、RAGデータの管理方法を変更：
1. **管理画面からのRAGアップロード機能を削除**
   - セキュリティリスクの軽減
   - 不正なデータアップロードの防止
2. **RAGデータの管理方法**
   - 開発者が事前にRAGデータを準備
   - デプロイ時にRAG DBファイルを含める
   - または、初回起動時に自動でRAGデータを読み込む
3. **実装案（CSV対応版）**
   ```
   # backend/data/rag_initial_data/
   # ├── departments/
   # │   ├── internal_medicine.csv
   # │   └── surgery.csv
   # └── chief_complaints/
   #     ├── internal_medicine_fever.csv
   #     └── internal_medicine_headache.csv
   ```
   - 起動時にこれらのCSVファイルからRAG DBを構築
   - 管理画面では「RAGデータ確認」のみ可能（読み取り専用）

**静的RAGデータ方式のメリット**:
- Renderの永続ディスク容量を節約（1GBの制限内で有効活用）
- デプロイが簡単（ファイルを含めるだけ）
- データ更新時は再デプロイで自動反映
- CSVファイルのままGit管理可能

**処理フロー**:
1. アプリ起動時にCSVファイルの存在確認
2. CSVファイルからデータを読み込み
3. メモリ内でベクトル化処理
4. SQLiteに保存（永続ディスクまたは一時ディスク）
5. 2回目以降の起動時は、CSVの更新日時をチェックして必要時のみ再構築

**想定工数**:
- バックエンド改修: 16時間
  - データモデル拡張: 4時間
  - API追加: 8時間
  - RAG処理ロジック: 4時間
- フロントエンド改修: 20時間
  - ユーザー画面: 12時間（新規ステップ追加）
  - 管理画面: 8時間（主訴管理機能）
- テスト・デバッグ: 8時間
- **合計: 44時間（5.5営業日）**

**リスク・懸念事項**:
- 主訴の選択肢が多すぎるとUXが悪化する可能性
- 主訴別RAGデータの準備・管理コストが増大
- 既存データとの互換性維持（主訴選択をスキップできるオプション）

**実装例（内科の主訴）**:
- 発熱・感冒症状
- 腹痛・消化器症状
- 頭痛・めまい
- 胸痛・動悸
- 全身倦怠感
- 咳・呼吸器症状
- その他（自由記述）

---

### RAGデータ管理方式の決定

**採用方式**: 静的RAGデータ方式（CSV版）

**理由**:
1. Renderの永続ディスク容量（1GB）を節約できる
2. デプロイが簡単（CSVファイルを含めるだけ）
3. 運用がシンプル（Git管理で完結）

**実装詳細**:
```
persona_render/
├── backend/
│   ├── data/
│   │   └── rag_initial_data/
│   │       ├── departments/
│   │       │   ├── internal_medicine.csv
│   │       │   ├── surgery.csv
│   │       │   └── ...（各診療科のCSV）
│   │       └── chief_complaints/
│   │           ├── internal_medicine_fever.csv
│   │           ├── internal_medicine_headache.csv
│   │           └── ...（各主訴のCSV）
│   └── services/
│       └── rag_initializer.py  # 新規作成
```

**動作フロー**:
1. アプリ起動時に`rag_initializer.py`が実行される
2. CSVファイルの存在と更新日時をチェック
3. 新規または更新があれば、CSVからデータを読み込み
4. ベクトル化処理を実行
5. SQLiteデータベースに保存（メモリ内またはtmpディレクトリ）
6. 以降のリクエストではこのDBを参照

**管理画面の変更**:
- RAGデータアップロード機能を削除
- RAGデータ一覧表示は残す（読み取り専用）
- 「最終更新日時」「データ件数」などの情報のみ表示

**メンテナンス方法**:
1. CSVファイルを更新
2. Gitにコミット＆プッシュ
3. Renderが自動的に再デプロイ
4. 新しいRAGデータが自動的に反映

---

### 要望3: 検索キーワード時系列分析によるマーケティング機能
**クライアントからの要望（原文）**:
> RAGデータ（Web検索キーワードベース）から、どういったキーワードで検索して病院を見つけたかを予測し、検索キーワードに紐づく「時系列データ」（CSV）を使い、グラフ表現やAIによる考察でマーケティングアドバイスを出力する機能を追加したい。

**現状の課題分析**:
- ペルソナ生成だけでは具体的なマーケティング施策に繋げにくい
- 患者の検索行動パターンが見えない
- いつ、どのタイミングでアプローチすべきかが不明

**プロ目線でのブラッシュアップ**:
1. **機能の位置づけ**
   - ペルソナ生成の「拡張機能」として実装
   - 生成結果画面に「マーケティング分析」タブを追加
   - 追加料金オプションとしても展開可能

2. **時系列データの活用方法**
   ```
   検索日-7日: 「頭痛 原因」（検索ボリューム: 1000）
   検索日-5日: 「頭痛 病院」（検索ボリューム: 500）
   検索日-3日: 「頭痛 内科 [地域名]」（検索ボリューム: 200）
   検索日当日: 「[医院名] 評判」（検索ボリューム: 50）
   ```

3. **出力内容の設計**
   - **グラフ表示**: 検索ボリュームの時系列推移
   - **AIによる考察**: 
     - 患者の心理状態の変化
     - 最適な広告出稿タイミング
     - 効果的なキーワード選定
   - **具体的なアクション提案**:
     - SEO対策キーワード
     - リスティング広告の設定
     - コンテンツマーケティング案

**技術的実現方法の提案**:
1. **データ構造**
   ```
   backend/data/time_series_data/
   ├── keywords/
   │   ├── headache_timeline.csv
   │   └── fever_timeline.csv
   └── mapping.json  # 主訴とキーワードセットの紐付け
   ```

2. **画面構成**
   - ペルソナ生成結果の下部に「マーケティング分析を見る」ボタン
   - クリックで分析結果セクションが展開
   - グラフ（Chart.js等）＋AIアドバイスを表示

3. **処理フロー**
   - 選択された主訴から関連キーワードセットを特定
   - 時系列CSVデータを読み込み
   - グラフ用データに変換
   - AIプロンプトに時系列データを含めて分析依頼

**想定工数**:
- バックエンド改修: 24時間
  - 時系列データ処理: 8時間
  - AI分析プロンプト設計: 8時間
  - API追加: 8時間
- フロントエンド改修: 32時間
  - グラフ表示機能: 16時間
  - UI/UX設計・実装: 16時間
- テスト・デバッグ: 8時間
- **合計: 64時間（8営業日）**

**リスク・懸念事項**:
- 時系列データの更新頻度とメンテナンス
- グラフ表示によるページ読み込み速度の低下
- Yahoo!ビジネスデータの利用規約確認が必要

**段階的実装の提案**:
1. **Phase 1**: シンプルなキーワード表示のみ
2. **Phase 2**: グラフ表示機能追加
3. **Phase 3**: AI分析・アドバイス機能追加

---

### 実装方法の詳細設計

**1. グラフ表示の仕様**
- **グラフタイプ**: 散布図（Scatter Plot）
- **X軸**: 検索時間差（-255日～+255日、0日が検索起点）
- **Y軸**: 検索ボリューム（対数スケール推奨）
- **プロット**: 各検索キーワードを点でプロット
- **実装例**:
  ```javascript
  // Chart.jsでの実装イメージ
  const data = {
    datasets: [{
      label: 'コンタクトレンズ 初めて',
      data: [{x: -30, y: 1200}, {x: -14, y: 800}],
      backgroundColor: 'rgba(255, 99, 132, 0.6)'
    }, {
      label: 'コンタクト 中学生',
      data: [{x: -7, y: 500}, {x: -3, y: 300}],
      backgroundColor: 'rgba(54, 162, 235, 0.6)'
    }]
  };
  ```

**2. CSVデータ形式**
```csv
keyword,days_from_search,search_volume,category
"コンタクトレンズ 初めて",-30,1200,"情報収集"
"コンタクト 中学生",-14,800,"比較検討"
"眼科 コンタクト 新宿",-3,300,"医院選定"
"○○眼科 評判",0,50,"最終確認"
```

**3. AI分析の実装**
- **入力データ**:
  - 選択された診療科・主訴
  - 時系列検索データ
  - 検索キーワードのカテゴリ分析
- **プロンプト設計例**:
  ```
  以下の検索行動データから、マーケティングの洞察を提供してください：
  
  診療科: 眼科
  主訴: コンタクトレンズ作成
  
  検索パターン:
  - 30日前: 「コンタクトレンズ 初めて」（1200回）
  - 14日前: 「コンタクト 中学生」（800回）
  - 7日前: 「コンタクト 部活」（400回）
  
  以下の観点で分析してください：
  1. 患者の真のニーズ
  2. 隠れた購買動機
  3. クロスセル・アップセルの機会
  4. 具体的なマーケティング施策
  ```

**4. 出力例**
```
【AI分析結果】
■ 患者インサイト
「コンタクトレンズ作成」で来院する患者の多くは、実は保護者が
中学生の子供のために来院しています。

■ 隠れたニーズ
- 部活動での使用を想定（スポーツ用レンズのニーズ）
- 思春期特有の外見への関心（カラコンへの潜在需要）
- 保護者の費用面での懸念

■ 推奨施策
1. 学生向けコンタクトレンズセットの用意
2. 部活動別のレンズ選びガイドの作成
3. 定期検診パックの提案（3ヶ月ごと）
4. ケア用品のまとめ買い割引
```

**5. UI配置**
- ペルソナ生成結果の下に「マーケティング分析」セクション追加
- 左側: 時系列グラフ（インタラクティブ）
- 右側: AI分析結果（テキスト）
- グラフの点にホバーでキーワード詳細表示

---

### 要望3の実装方針（確定）

**実装内容**:
1. **散布図グラフ**
   - X軸: 検索時間差（-255日～+255日）
   - Y軸: 検索ボリューム（対数スケール）
   - 検索キーワードごとにプロット
   - Chart.jsでインタラクティブに実装

2. **AI分析機能**
   - 検索パターンから患者の真のニーズを分析
   - 隠れた購買動機の発見
   - 具体的なマーケティング施策の提案
   - 例：「コンタクトレンズ検索」→「実は保護者が子供のために来院」という洞察

**データ管理**:
- 時系列CSVデータは静的ファイルとして管理
- 診療科×主訴ごとにCSVファイルを用意
- Yahoo!ビジネスデータと同じ形式で保存

**期待される効果**:
- 患者の検索行動から「見えないニーズ」を可視化
- データに基づいた具体的なマーケティング施策立案
- 医療機関の収益向上に直結する提案が可能

---

### 要望4: 3C分析・競合分析機能
**クライアントからの要望（原文）**:
> 3C分析機能をペルソナ生成機能とは別に追加したい。自分のクリニック情報を入れると、近隣の同じ診療科のクリニックの口コミを分析して、SWOT分析をしてくれる。Ahrefs（エイチレフス）も契約しているので、PV/UUなども抽出可能。MCPでAhrefsと連携できれば最高。

**現状の課題分析**:
- 競合クリニックの強み・弱みが把握できていない
- 自院の市場でのポジショニングが不明確
- デジタルマーケティングの効果測定ができていない

**プロ目線でのブラッシュアップ**:
1. **3C分析の構成**
   - Customer（市場・患者）: 地域の人口動態、患者ニーズ
   - Competitor（競合）: 近隣クリニックの特徴・評価
   - Company（自社）: 自院の強み・弱み

2. **データソースの統合**
   - **口コミデータ**: Googleマップ、病院口コミサイト
   - **Webトラフィック**: Ahrefs（PV、UU、検索順位）
   - **基本情報**: 診療時間、アクセス、設備等

3. **SWOT分析の自動生成**
   ```
   【強み（Strengths）】
   - 土日診療で他院より利便性高い
   - 「親切な対応」の口コミ多数（85%がポジティブ）
   
   【弱み（Weaknesses）】
   - Webサイトの月間PVが競合の1/3
   - 駐車場なしが不満要因（口コミ分析より）
   
   【機会（Opportunities）】
   - 地域の高齢化で内科需要増加
   - オンライン診療未実施の競合が多い
   
   【脅威（Threats）】
   - 大手医療法人が近隣に進出予定
   - 競合A院のSEO対策が強力
   ```

**技術的実現方法の提案**:
1. **MCP（Model Context Protocol）連携**
   - Ahrefsは現時点でMCP非対応の可能性大
   - 代替案1: Ahrefs APIを直接実装
   - 代替案2: CSVエクスポート→静的ファイル読み込み
   - 将来的にMCP対応時は移行可能な設計に

2. **データ収集フロー**
   ```
   ユーザー入力
   ├─ 自院情報（名称、住所、診療科）
   └─ 分析範囲（半径◯km以内）
   
   自動収集
   ├─ Google Maps API → 競合リスト・口コミ
   ├─ Ahrefs API/CSV → トラフィックデータ
   └─ 公開情報クローリング → 診療時間等
   ```

3. **画面構成**
   - 新規メニュー「競合分析」を追加
   - ダッシュボード形式で結果表示
   - エクスポート機能（PDF/PPT）

**想定工数**:
- バックエンド改修: 40時間
  - データ収集API実装: 16時間
  - 分析ロジック: 16時間
  - Ahrefs連携: 8時間
- フロントエンド改修: 24時間
  - 新規画面作成: 16時間
  - 結果表示UI: 8時間
- テスト・デバッグ: 8時間
- **合計: 72時間（9営業日）**

**リスク・懸念事項**:
- Google Maps APIの利用制限・料金
- 口コミデータの著作権・利用規約
- Ahrefs APIの料金体系（追加費用の可能性）
- 競合情報の更新頻度とデータ鮮度

**段階的実装案**:
1. **Phase 1**: 手動入力による簡易SWOT分析
2. **Phase 2**: Google Maps API連携で口コミ自動収集
3. **Phase 3**: Ahrefs連携でデジタル分析追加

---

## 実装に向けた具体的なアプローチ

### Ahrefs APIについて（重要情報）
**結論**: Ahrefs APIは**エンタープライズプラン限定**
- 通常のプラン（スターター、ライト、スタンダード、アドバンスド）ではAPI利用不可
- エンタープライズプランへの申し込みが必要（別途見積もり）
- 2024年3月にAPI v2廃止、v3への移行が必要

### 実装方法の現実的な提案

#### 方法1: CSVアップロード方式（推奨）
```
実装フロー:
1. Ahrefsの管理画面から手動でデータエクスポート（CSV）
2. CSVファイルをシステムにアップロード
3. AIが分析してSWOT分析を生成

メリット:
- 追加コストなし
- すぐに実装可能
- エンタープライズプラン不要

デメリット:
- 手動作業が必要
- リアルタイム性がない
```

#### 方法2: スクレイピング＋手動入力のハイブリッド
```
データ収集:
- Google Maps API: 口コミ・基本情報（自動）
- Ahrefs: CSV手動アップロード
- 診療時間等: フォーム入力

実装の優先順位:
1. まずCSVアップロード機能を実装
2. Google Maps API連携を追加
3. 将来的にAPI対応（エンタープライズ契約時）
```

### 各要望の実装イメージ

#### 要望1: 診療科別アクセス制御
```python
# backend/main.py に追加
@app.get("/medical")
async def medical_page(credentials: HTTPBasicCredentials = Depends(verify_medical_credentials)):
    # 医科のみ表示するページ
    departments = get_medical_departments()
    return templates.TemplateResponse("index.html", {"departments": departments})

# 環境変数
MEDICAL_USERNAME=medical_user
MEDICAL_PASSWORD=secure_pass_1
```

#### 要望2: 主訴別RAG
```python
# backend/data/rag_initial_data/chief_complaints/
# 内科_発熱.csv をアプリ起動時に自動読み込み

class RAGInitializer:
    def load_on_startup(self):
        for csv_file in Path("data/rag_initial_data").glob("**/*.csv"):
            self.import_to_db(csv_file)
```

#### 要望3: 時系列分析
```javascript
// フロントエンドでChart.js使用
const timeSeriesChart = new Chart(ctx, {
    type: 'scatter',
    data: {
        datasets: [{
            label: '頭痛 原因',
            data: [{x: -7, y: 1000}, {x: -5, y: 800}]
        }]
    },
    options: {
        scales: {
            x: { min: -255, max: 255 },
            y: { type: 'logarithmic' }
        }
    }
});
```

#### 要望4: 3C/SWOT分析
```python
# CSVアップロード画面
@app.post("/api/upload/ahrefs-data")
async def upload_ahrefs_csv(file: UploadFile):
    # CSVを解析してトラフィックデータ抽出
    df = pd.read_csv(file.file)
    traffic_data = analyze_traffic(df)
    
    # AIにSWOT分析を依頼
    swot = await generate_swot_analysis(traffic_data)
    return swot
```

### 段階的な実装計画
1. **第1フェーズ（2-3週間）**
   - 診療科別アクセス制御
   - 主訴選択機能（RAGなし）
   
2. **第2フェーズ（3-4週間）**
   - 静的RAGデータ読み込み
   - 時系列グラフ表示
   
3. **第3フェーズ（4-5週間）**
   - 3C/SWOT分析（CSV版）
   - AI分析機能統合

この段階的アプローチなら、現実的に実装可能です。どの機能から着手しますか？

---

## Ahrefs（エイチレフス）でできること

### 主要5大機能

1. **サイトエクスプローラー**
   - 競合サイトのトラフィック数（月間PV・UU）
   - どんなキーワードで上位表示されているか
   - 被リンク数と質の分析
   - オーガニック検索の推移

2. **キーワードエクスプローラー**
   - キーワードの月間検索ボリューム
   - 上位表示の難易度（1-100）
   - 関連キーワードの提案
   - SERP（検索結果）の分析

3. **ランクトラッカー**
   - 自サイト・競合サイトの順位追跡
   - 順位変動のアラート
   - グラフで視覚化

4. **コンテンツエクスプローラー**
   - SNSでバズっているコンテンツ発見
   - 競合の人気記事分析

5. **サイト監査**
   - 技術的なSEO問題の発見
   - サイトスピード・モバイル対応

### 医療機関の3C/SWOT分析での活用例

**競合分析で取得できるデータ**:
```
例：「新宿 内科」で検索した競合クリニック

A院：
- 月間オーガニックトラフィック: 15,000
- 上位表示キーワード数: 450
- ドメインレーティング: 35
- 被リンク数: 1,200

B院（自院）：
- 月間オーガニックトラフィック: 3,000
- 上位表示キーワード数: 120
- ドメインレーティング: 15
- 被リンク数: 200

→ A院はB院の5倍のトラフィック！
→ 「新宿 内科 日曜」でA院1位、B院圏外
→ A院は医療系ポータルからの被リンク多数
```

**CSVエクスポートで取得できる情報**:
- 競合の上位表示キーワード一覧
- トラフィック推移（過去2年分）
- 被リンク元サイト一覧
- ページ別のトラフィック

### SWOT分析への活用

**AIに渡すデータ例**:
```
自院：トラフィック3,000、キーワード120個
競合A：トラフィック15,000、キーワード450個
競合B：トラフィック8,000、キーワード280個

自院の強みキーワード：「内科 夜間診療」（5位）
競合の強みキーワード：「内科 日曜診療」（1位）
```

これらのデータをAIが分析して、具体的な改善提案を生成します。

### Ahrefsだけで近隣競合を自動発見できるか？

**答え：いいえ、Ahrefsだけでは不可能です**

**Ahrefsでできること**:
- URLを入力した特定サイトの分析（要手動入力）
- キーワード検索結果の上位サイト表示
- 競合サイトの詳細分析

**Ahrefsでできないこと**:
- 地理的な位置情報からの自動検索
- 「半径5km以内の内科クリニック」のような検索
- 診療科による自動フィルタリング

### 近隣競合を発見する現実的な方法

**方法1：Google Maps API + Ahrefs（推奨）**
```
1. Google Maps APIで近隣クリニックをリスト化
   入力：「新宿区 内科」+ 半径5km
   出力：クリニック名、住所、URL、口コミ

2. 取得したURLをAhrefsで分析
   各クリニックのトラフィック・キーワードを調査

3. データを統合してAIで分析
```

**方法2：手動リストアップ + Ahrefs**
```
1. Google検索で「地域名 診療科」で検索
2. 上位10-20件のクリニックURLをリスト化
3. AhrefsでバッチでCSVエクスポート
4. システムにアップロードして分析
```

### 実装の現実的なフロー

```
ユーザー入力画面：
- クリニック名：○○内科
- 住所：東京都新宿区○○
- 診療科：内科
- 分析範囲：5km

↓

システム処理：
1. Google Maps APIで近隣リスト取得（自動）
2. 「競合URLリストをAhrefsで調査してCSVをアップロードしてください」と案内
3. CSVアップロード後、AIが分析

↓

出力：
- 競合マップ（地図上にプロット）
- SWOT分析
- 改善提案
```

この方法なら、半自動で効率的に競合分析ができます。完全自動化は難しいですが、実用的なレベルで実現可能です。

### ワンストップ実装は可能か？

**理論上は可能だが、制約あり**

**ケース1：エンタープライズプランの場合（API利用可能）**
```python
# 完全自動化のフロー
async def analyze_competitors():
    # 1. Google Maps APIで競合リスト取得
    competitors = await get_nearby_clinics("新宿", "内科", radius=5000)
    
    # 2. Ahrefs APIで各URLを分析（ループ処理）
    for clinic in competitors:
        traffic_data = await ahrefs_api.get_domain_metrics(clinic.url)
        keyword_data = await ahrefs_api.get_top_keywords(clinic.url)
    
    # 3. 結果をまとめてAI分析
    return generate_swot_analysis(all_data)
```

**問題点**：
- API利用制限（1回のリクエストで消費するクレジット）
- 10件の競合分析で大量のAPIクレジット消費
- 追加コストが発生する可能性大

**ケース2：通常プランの場合（API利用不可）**
```
完全自動化は不可能
→ 必ず人間の手作業が必要
```

### 現実的な実装案

**セミオートメーション方式**
```
1. システム側の処理（自動）
   - Google Maps APIで競合リスト生成
   - URLリストをCSV形式でダウンロード提供
   - 「このCSVをAhrefsにインポートしてください」と案内

2. ユーザー側の作業（手動：5-10分）
   - AhrefsのBatch Analysis機能でURL一括入力
   - 結果をCSVエクスポート

3. システム側の処理（自動）
   - CSVアップロード受付
   - データ解析・SWOT分析生成
```

**画面フロー例**：
```
[競合分析開始] 
↓
[近隣10クリニック発見！]
↓
[URLリストをダウンロード] ← ここで一旦手動作業
↓
[Ahrefs分析済みCSVをアップロード]
↓
[SWOT分析結果表示]
```

この方式なら：
- エンタープライズプラン不要
- ユーザーの作業は5-10分程度
- コスト効率的

完全ワンストップは難しいですが、実用上は十分スムーズな体験を提供できます。

### ユーザーがAhrefsを使えない場合の対策

**事前データ収集は現実的か？**

**ケース1：全国の医療機関を事前収集（非現実的）**
```
全国の医療機関数：約18万施設
診療科別：約30科
= 膨大すぎて無理
```

**ケース2：主要都市×主要診療科に限定（ギリギリ可能？）**
```
東京23区 + 主要都市（10都市）
× 主要診療科（内科、外科、歯科など10科）
× 各エリア上位20施設
= 約2,200施設

月1回更新でも相当な作業量...
```

### 現実的な代替案

**案1：口コミ・基本情報だけでSWOT分析**
```python
# Ahrefsを使わない競合分析
1. Google Maps API：
   - 口コミ数・評価
   - 営業時間
   - 混雑状況
   - 写真の数

2. 独自クローリング：
   - 診療科目
   - 設備情報
   - アクセス情報

3. その他のデータソース：
   - 厚労省の医療機関データ
   - 病院なび等の公開API
```

**案2：簡易的なWeb分析を独自実装**
```python
# 最低限のSEO情報を取得
- ページタイトル・メタ情報
- SSL対応有無
- モバイル対応
- ページ表示速度（PageSpeed API）
- SNSでのシェア数
```

**案3：段階的アプローチ**
```
Phase 1：口コミベースのSWOT分析
- Google Maps APIのみで実装
- 「親切」「待ち時間」等のキーワード分析

Phase 2：協力医療機関のデータ蓄積
- 利用する医療機関が自院のAhrefsデータを提供
- 徐々にデータベース構築

Phase 3：代替指標の開発
- Ahrefsに依存しない独自指標
- 口コミ×立地×診療時間の総合スコア
```

### 推奨する現実解

**「口コミ特化型SWOT分析」として割り切る**

```
強み：土日診療で「助かる」の口コミ多数
弱み：「待ち時間が長い」が全体の30%
機会：「小児科が少ない」エリア
脅威：新規開業の評価が急上昇中

→ これだけでも十分価値がある！
```

Ahrefsのトラフィックデータは諦めて、Google Maps APIで取れる情報を最大限活用する方が現実的です。

---

## 要望4の実装方針（最終決定）

### Google Maps API特化型の3C/SWOT分析

**実装内容**：
1. **競合自動検出**
   - Google Places APIで近隣の同診療科クリニックを検索
   - 半径指定（1km、3km、5km）で柔軟に対応

2. **取得データ**
   ```python
   {
     "name": "○○クリニック",
     "rating": 4.2,
     "user_ratings_total": 156,
     "reviews": [...],  # 口コミテキスト
     "opening_hours": {...},
     "geometry": {"lat": 35.123, "lng": 139.456},
     "photos": [...],
     "price_level": 2,
     "website": "https://example.com"
   }
   ```

3. **AI分析項目**
   - 口コミのセンチメント分析
   - 頻出キーワード抽出（「親切」「待ち時間」等）
   - 営業時間の差別化ポイント
   - アクセス面での優位性

**画面構成**：
```
[3C/SWOT分析] メニュー
  ↓
[自院情報入力]
- クリニック名
- 住所（またはGoogle Maps上で選択）
- 診療科
- 分析範囲（半径km）
  ↓
[分析実行]
  ↓
[結果表示]
- 競合マップ（地図上にプロット）
- SWOT分析結果
- 改善提案
- PDF/PPTエクスポート
```

**必要なAPI**：
- Google Places API（Nearby Search）
- Google Places API（Place Details）
- Google Maps JavaScript API（地図表示）

**料金目安**：
- Places API: $0.032/リクエスト
- 10件の詳細取得で約$0.32（約50円）

この方針で実装を進めます！

---
