<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CSV完全テスト</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 15px; background: #f5f5f5; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #3b82f6; color: white; border: none; border-radius: 4px; }
        button:hover { background: #2563eb; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .form-group { margin: 10px 0; }
        .form-group label { display: inline-block; width: 150px; }
        .form-group input, .form-group textarea { width: 300px; padding: 5px; }
        textarea { vertical-align: top; }
        pre { background: #1e293b; color: #f1f5f9; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>競合分析 CSV アップロード完全テスト</h1>
    
    <div class="test-section">
        <h2>1. サンプルCSVでテスト</h2>
        <button onclick="testSampleCSV()">サンプルCSV（UTF-8）</button>
        <button onclick="testShiftJISCSV()">サンプルCSV（Shift-JIS想定）</button>
        <div id="result1" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 模擬フォーム</h2>
        <div class="form-group">
            <label>クリニック名:</label>
            <input type="text" id="clinic-name" />
        </div>
        <div class="form-group">
            <label>郵便番号:</label>
            <input type="text" id="postal-code" />
        </div>
        <div class="form-group">
            <label>住所:</label>
            <input type="text" id="address" />
        </div>
        <div class="form-group">
            <label>診療科:</label>
            <select id="department">
                <option value="">選択してください</option>
                <option value="内科">内科</option>
                <option value="外科">外科</option>
                <option value="歯科">歯科</option>
            </select>
        </div>
        <div class="form-group">
            <label>クリニックの強み:</label>
            <textarea id="clinic-features" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label>ターゲット層:</label>
            <textarea id="target-patients" rows="2"></textarea>
        </div>
        <button onclick="clearForm()">フォームクリア</button>
        <button onclick="showFormValues()">現在の値を表示</button>
    </div>
    
    <div class="test-section">
        <h2>3. ファイルアップロードテスト</h2>
        <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
        <div id="result3" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. エンコーディング検出テスト</h2>
        <button onclick="createTestFiles()">テストファイル生成方法を表示</button>
        <div id="result4" class="result"></div>
    </div>

    <script>
        // CSVパース関数（本番と同じ）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            if (current || line.endsWith(',')) {
                result.push(current.trim());
            }
            
            return result;
        }
        
        function parseAndFillCSVData(csvContent) {
            console.log('=== CSV解析開始 ===');
            console.log('CSV content:', csvContent);
            
            // BOM削除
            if (csvContent.charCodeAt(0) === 0xFEFF) {
                console.log('BOM detected and removed');
                csvContent = csvContent.slice(1);
            }
            
            const lines = csvContent.split(/\r?\n/).filter(line => line.trim());
            console.log('Lines:', lines);
            
            const headers = parseCSVLine(lines[0]);
            const data = lines[1] ? parseCSVLine(lines[1]) : [];
            
            const dataMap = {};
            headers.forEach((header, index) => {
                dataMap[header.trim()] = data[index] || '';
            });
            
            console.log('Data map:', dataMap);
            
            // フォームに値を設定
            if (dataMap['クリニック名']) {
                document.getElementById('clinic-name').value = dataMap['クリニック名'];
            }
            if (dataMap['郵便番号']) {
                document.getElementById('postal-code').value = dataMap['郵便番号'];
            }
            if (dataMap['住所']) {
                document.getElementById('address').value = dataMap['住所'];
            }
            if (dataMap['診療科']) {
                const select = document.getElementById('department');
                select.value = dataMap['診療科'];
            }
            if (dataMap['クリニックの強み・特徴']) {
                document.getElementById('clinic-features').value = dataMap['クリニックの強み・特徴'];
            }
            if (dataMap['主なターゲット層']) {
                document.getElementById('target-patients').value = dataMap['主なターゲット層'];
            }
            
            return dataMap;
        }
        
        function testSampleCSV() {
            const csv = 'クリニック名,郵便番号,住所,診療科,クリニックの強み・特徴,主なターゲット層\n田中内科クリニック,107-0052,東京都港区赤坂4-9-11,内科,土日診療対応・最新機器導入・専門医3名在籍,働く世代・ファミリー層';
            
            const dataMap = parseAndFillCSVData(csv);
            
            let result = '<div class="success">✓ CSV解析成功</div>';
            result += '<pre>' + JSON.stringify(dataMap, null, 2) + '</pre>';
            document.getElementById('result1').innerHTML = result;
        }
        
        function testShiftJISCSV() {
            // Shift-JISテスト（実際にはブラウザで変換できないので説明のみ）
            const result = `
                <div>Shift-JISファイルのテスト方法:</div>
                <ol>
                    <li>Excelで新規ファイルを作成</li>
                    <li>以下のデータを入力:
                        <pre>クリニック名,郵便番号,住所,診療科,クリニックの強み・特徴,主なターゲット層
田中内科クリニック,107-0052,東京都港区赤坂4-9-11,内科,土日診療対応,働く世代</pre>
                    </li>
                    <li>「名前を付けて保存」→「CSV (コンマ区切り)」で保存</li>
                    <li>このファイルをアップロードしてテスト</li>
                </ol>
            `;
            document.getElementById('result1').innerHTML = result;
        }
        
        function clearForm() {
            document.getElementById('clinic-name').value = '';
            document.getElementById('postal-code').value = '';
            document.getElementById('address').value = '';
            document.getElementById('department').value = '';
            document.getElementById('clinic-features').value = '';
            document.getElementById('target-patients').value = '';
            alert('フォームをクリアしました');
        }
        
        function showFormValues() {
            const values = {
                'クリニック名': document.getElementById('clinic-name').value,
                '郵便番号': document.getElementById('postal-code').value,
                '住所': document.getElementById('address').value,
                '診療科': document.getElementById('department').value,
                'クリニックの強み': document.getElementById('clinic-features').value,
                'ターゲット層': document.getElementById('target-patients').value
            };
            
            alert('現在のフォーム値:\n\n' + JSON.stringify(values, null, 2));
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('File:', file);
            
            // 両方のエンコーディングを試す
            const readers = [
                { encoding: 'UTF-8', reader: new FileReader() },
                { encoding: 'Shift-JIS', reader: new FileReader() }
            ];
            
            let results = [];
            let completed = 0;
            
            readers.forEach(({encoding, reader}) => {
                reader.onload = function(e) {
                    const content = e.target.result;
                    const hasJapanese = /[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf]/.test(content);
                    
                    results.push({
                        encoding,
                        hasJapanese,
                        content: content.substring(0, 200)
                    });
                    
                    completed++;
                    if (completed === readers.length) {
                        // 日本語が正しく読めた方を選択
                        const validResult = results.find(r => r.hasJapanese);
                        if (validResult) {
                            console.log('Selected encoding:', validResult.encoding);
                            const fullReader = new FileReader();
                            fullReader.onload = (e) => {
                                const dataMap = parseAndFillCSVData(e.target.result);
                                document.getElementById('result3').innerHTML = 
                                    `<div class="success">✓ ${validResult.encoding}で読み込み成功</div>` +
                                    `<pre>${JSON.stringify(dataMap, null, 2)}</pre>`;
                            };
                            fullReader.readAsText(file, validResult.encoding);
                        } else {
                            document.getElementById('result3').innerHTML = 
                                '<div class="error">日本語を検出できませんでした</div>';
                        }
                    }
                };
                
                reader.readAsText(file, encoding);
            });
        }
        
        function createTestFiles() {
            const result = `
                <h3>テストCSVファイルの作成方法</h3>
                
                <h4>1. UTF-8 (BOM付き) - メモ帳で作成</h4>
                <ol>
                    <li>メモ帳を開く</li>
                    <li>以下をコピペ:
                        <pre>クリニック名,郵便番号,住所,診療科,クリニックの強み・特徴,主なターゲット層
山田歯科医院,150-0001,東京都渋谷区神宮前1-2-3,歯科,最新設備・予約制・キッズスペース完備,ファミリー層</pre>
                    </li>
                    <li>「名前を付けて保存」→ 文字コード「UTF-8 (BOM付き)」</li>
                </ol>
                
                <h4>2. Shift-JIS - Excelで作成</h4>
                <ol>
                    <li>Excelで新規作成</li>
                    <li>A1セルから順に入力</li>
                    <li>「名前を付けて保存」→「CSV (コンマ区切り)」</li>
                </ol>
            `;
            document.getElementById('result4').innerHTML = result;
        }
    </script>
</body>
</html>