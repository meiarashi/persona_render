# 競合分析機能強化 - 設定ガイド

## 概要
競合分析の精度と深度を大幅に向上させるため、以下の外部APIとの統合を実装しました。

## 必要な環境変数

### 1. SerpAPI（Google検索結果取得）
```
SERPAPI_KEY=your_serpapi_key_here
```
- 取得先: https://serpapi.com/
- 用途: 競合医院のWeb検索、ニュース検索、口コミ集約
- 料金: 月100回まで無料、その後従量課金

### 2. e-Stat API（政府統計データ）
```
ESTAT_API_KEY=your_estat_key_here
```
- 取得先: https://www.e-stat.go.jp/api/
- 用途: 地域の人口統計、医療需要推定
- 料金: 無料（要登録）

### 3. 既存のAPI（必須）
```
GOOGLE_MAPS_API_KEY=AIza...
OPENAI_API_KEY=sk-...
```

## 新機能の詳細

### 1. Web Research Service
- **競合医院の詳細情報収集**
  - 公式サイトの自動解析
  - SNSプレゼンスチェック
  - 最新ニュース・プレスリリース収集
  - 複数口コミサイトからの評判集約

### 2. Regional Data Service  
- **地域特性データ取得**
  - 人口統計（年齢分布、世帯数）
  - 医療需要推定
  - 経済指標
  - 医療機関密度分析

### 3. 強化されたSWOT分析
- **より詳細な競合情報**
  - 各競合の特徴的サービス
  - オンライン戦略の把握
  - 患者評価の詳細分析

- **地域特性を考慮した戦略提案**
  - 高齢化率に基づく診療戦略
  - 人口密度を考慮した集患戦略
  - 地域の医療需要に応じたサービス設計

## セットアップ手順

1. **SerpAPIキーの取得**
   ```bash
   # 1. https://serpapi.com/ でアカウント作成
   # 2. ダッシュボードからAPIキーを取得
   # 3. Renderの環境変数に設定
   ```

2. **e-Stat APIキーの取得**
   ```bash
   # 1. https://www.e-stat.go.jp/api/ でユーザー登録
   # 2. マイページからAPIキーを取得
   # 3. Renderの環境変数に設定
   ```

3. **Renderでの環境変数設定**
   - Renderダッシュボードにログイン
   - サービスの「Environment」タブを開く
   - 上記の環境変数を追加
   - 「Save Changes」をクリック

## 動作確認

APIキーが正しく設定されているか確認：

```python
# backend/services/web_research_service.py
import os

# 設定確認
print("SERPAPI_KEY:", "設定済み" if os.getenv("SERPAPI_KEY") else "未設定")
print("ESTAT_API_KEY:", "設定済み" if os.getenv("ESTAT_API_KEY") else "未設定")
```

## トラブルシューティング

### SerpAPIが動作しない場合
- APIキーが正しいか確認
- 無料枠の使用上限に達していないか確認
- ファイアウォール設定を確認

### e-Stat APIが動作しない場合
- APIキーが有効か確認
- リクエスト制限（1分間に10回）を超えていないか確認

### 競合分析が以前と変わらない場合
- 環境変数が正しくRenderに設定されているか確認
- サービスを再起動してみる
- ログで"Retrieved detailed info for X competitors"が出力されているか確認

## 期待される改善効果

1. **分析の深度向上**
   - 競合の詳細な特徴を把握
   - 地域特性に基づいた戦略立案
   - より具体的で実行可能な提案

2. **情報の網羅性**
   - Web上の最新情報を自動収集
   - 複数の情報源からデータ統合
   - リアルタイムの市場動向把握

3. **戦略の精度向上**
   - データドリブンな意思決定支援
   - 地域医療需要に基づく差別化戦略
   - 競合の弱点を突く具体的施策

## 注意事項

- APIキーは絶対に公開しないこと
- 無料枠の使用量に注意（特にSerpAPI）
- 大量のリクエストを短時間で送らないこと（レート制限あり）

## サポート

問題が発生した場合は、以下の情報と共にお問い合わせください：
- エラーメッセージの全文
- 使用している環境（ローカル/Render）
- 設定済みの環境変数（キーの値は除く）