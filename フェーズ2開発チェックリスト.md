# フェーズ2開発チェックリスト

## 🔧 Phase 1: 基盤整備（5時間）✅ 完了

### 環境準備
- [x] 環境変数の追加（MEDICAL_PASS, DENTAL_PASS, OTHERS_PASS）
- [x] Google Maps API キーの取得と設定
- [x] 開発用ブランチの作成

### プロジェクト構造調整
- [x] 診療科別のディレクトリ構造作成
  - [x] `/frontend/medical/`
  - [x] `/frontend/dental/`
  - [x] `/frontend/others/`
- [x] 共通コンポーネントディレクトリの作成
  - [x] `/frontend/shared/`

### Basic認証の拡張
- [x] `auth.py`に診療科別認証関数を追加
- [x] 環境変数からのパスワード読み込み実装

## 🏥 Phase 2: 診療科別アクセス制御（3時間）✅ 完了

### ルーティング設定
- [x] `main.py`に診療科別エンドポイント追加
  - [x] `/medical` エンドポイント
  - [x] `/dental` エンドポイント
  - [x] `/others` エンドポイント
- [x] 各エンドポイントにBasic認証適用
- [x] 診療科別のindex.htmlファイル作成

### UI実装
- [x] 診療科選択画面の作成
- [x] 各診療科用のカスタマイズ（ロゴ、カラーテーマ）
- [x] レスポンシブ対応の確認

### 追加実装
- [x] 診療科カテゴリー別APIの実装
- [x] 動的な診療科読み込み機能（department-loader.js）
- [x] イベントリスナーの修正（ボタン選択問題の解決）

## 📋 Phase 3: 主訴別ペルソナ生成（10時間）✅ 完了

### データ構造の準備 ✅ 完了
- [x] `config/chief_complaints.json`の作成
  - [x] 医科の主訴データ（19診療科）
    - 眼科: 15項目
    - 内科: 26項目
    - 外科: 20項目
    - 小児科: 35項目
    - 整形外科: 21項目
    - 耳鼻咽喉科: 16項目
    - 皮膚科: 19項目
    - 婦人科: 18項目
    - 泌尿器科: 20項目
    - 精神科: 21項目
    - 脳神経外科: 20項目
    - 循環器内科: 16項目
    - 消化器内科: 19項目
    - 呼吸器内科: 14項目
    - 糖尿病内科: 10項目
    - 腎臓内科: 13項目
    - 神経内科: 15項目
    - 血液内科: 12項目
    - 内分泌科: 11項目
  - [x] 歯科の主訴データ（5診療科）
    - 歯科: 19項目
    - 小児歯科: 16項目
    - 審美歯科: 11項目
    - 矯正歯科: 16項目
    - 口腔外科: 22項目
  - [x] その他の主訴データ（6診療科）
    - 麻酔科: 10項目
    - 放射線科: 11項目
    - リハビリテーション科: 15項目
    - アレルギー科: 13項目
    - 形成外科: 16項目
    - 美容外科: 16項目
- [x] 主訴別のペルソナテンプレート作成（プロンプトに組み込み）
- [x] RAGデータのCSVファイル準備（各診療科別主訴.csv使用）

### API実装 ✅ 完了
- [x] 主訴リスト取得エンドポイント
  - `GET /api/chief-complaints/{category}/{department}`
  - カテゴリと診療科名から主訴リストを返す
- [x] 主訴別ペルソナ生成エンドポイント
  - `POST /api/generate-by-complaint`
  - 主訴を含めたペルソナ生成
- [x] 既存のペルソナ生成ロジックとの統合

### UI実装（3ステップフロー）
- [x] ステップ1: 診療科選択画面
- [x] ステップ2: 主訴選択画面
- [x] ステップ3: 作成目的選択画面
- [x] プログレスバーの実装（6ステップに変更）
- [x] 戻るボタンの実装
- [x] 医科（medical）の実装完了
- [x] 歯科（dental）の実装完了
- [x] その他（others）の実装完了
- [x] 管理者（admin）の実装完了
- [x] PDFとPPTのUIに主訴を追加

### バグ修正と改善 ✅ 完了
- [x] loadChiefComplaints関数の実装
- [x] TOTAL_FORM_STEPSを5から6に変更
- [x] 部門選択ボタンの色変更問題の修正
- [x] 主訴選択画面の表示問題の解決
- [x] ペルソナ生成の500エラー修正
- [x] AI生成結果が空になる問題の解決
- [x] /api/generateエンドポイントへの統合（新規エンドポイント削除）

### パフォーマンス最適化 ✅ 完了
- [x] インメモリキャッシュ実装（cache_manager.py）
  - [x] スレッドセーフティ対応（threading.RLock）
  - [x] 個別TTL管理
  - [x] LRUエビクション機能
  - [x] 定期的なクリーンアップ（5分間隔）
- [x] フロントエンドキャッシュ実装（chief-complaints-cache.js）
  - [x] LocalStorageを使用した24時間キャッシュ
  - [x] 優先度付きプリロード（よく使う診療科を優先）
  - [x] バッチ処理によるサーバー負荷軽減
  - [x] XSS対策とデータ検証
- [x] 全ページへの適用
  - [x] medical/index.html, script.js
  - [x] dental/index.html, script.js
  - [x] others/index.html, script.js
  - [x] user/index.html, script.js
- [x] 主訴表示の高速化（3秒→0.3秒）

### RAGデータのコードベース管理への移行 ✅ 完了
- [x] CSVファイルの自動読み込み機能実装
  - [x] `/rag/各診療科/{診療科名}/{診療科名}_全体.csv`からの自動ロード
  - [x] `load_csv_data_from_directory()`関数の実装
  - [x] システム起動時の自動読み込み
- [x] 管理スクリプトの作成
  - [x] `scripts/manage_rag_data.py`の作成
  - [x] init/reload/statusコマンドの実装
- [x] 既存機能との統合
  - [x] `init_rag_database()`への統合
  - [x] 管理画面アップロード機能は残存（互換性のため）
- [ ] 主訴別データの実装
  　- 一部を除き全データの登録完了。https://docs.google.com/spreadsheets/d/1MfrMl6e-Lhc_XJjFynaXLnIlBv486bmAHLiBwbqvWJs/edit?gid=79355194#gid=79355194
  　-　泌尿器科>性病のCSVが頻尿と間違っている。
  　-　精神科>薬物依存症のCSVがデータ空
    -  十二指腸潰瘍のCSVが存在しない
    -　多分Yahooビジネス空エクスポートできる気がする

## 📊 Phase 4: 検索キーワード時系列分析（12時間）✅ 完了

### Chart.js統合 ✅ 完了
- [x] Chart.jsのCDN追加（全ページに統合済み）
- [x] 散布図コンポーネントの作成
- [x] レスポンシブチャート設定

### データ処理 ✅ 完了
- [x] サンプルデータJSONの作成
- [x] 時系列データ処理エンドポイント（/api/timeline-analysis）
- [x] データフォーマット変換関数（timeline_analyzer.py）

### AI分析機能 ✅ 完了
- [x] 時系列分析用プロンプトテンプレート作成
- [x] AIレポート生成エンドポイント
- [x] レポート表示コンポーネント

### UI実装 ✅ 完了
- [x] 時系列分析ページの作成（結果画面に統合）
- [x] データアップロード機能（CSV）
- [x] 期間選択フィルター
- [x] エクスポート機能（PDF/画像）

## 🎯 Phase 5: 競合分析（3C/SWOT分析）（10時間）

### Google Maps API統合
- [ ] Places APIの有効化
- [ ] 競合検索関数の実装
- [ ] 検索半径の設定機能

### 分析ロジック
- [ ] 自院情報入力フォーム
- [ ] 競合自動検出アルゴリズム
- [ ] 競合情報の取得と整形

### SWOT分析生成
- [ ] SWOT分析テンプレートの作成
- [ ] AI分析プロンプトの作成
- [ ] 分析結果の構造化

### UI実装
- [ ] 競合分析ページの作成
- [ ] 自院情報入力フォーム
- [ ] 競合リスト表示
- [ ] SWOT分析結果表示
- [ ] レポートエクスポート機能

## 🧪 Phase 6: テストと調整（3時間）

### 統合テスト ✅ 完了
- [x] 診療科別アクセスのテスト
- [x] 主訴別ペルソナ生成のテスト
- [x] 時系列分析のテスト
- [ ] 競合分析のテスト

### パフォーマンス最適化 ✅ 完了
- [x] API レスポンスの最適化（キャッシュ実装）
- [x] フロントエンドの読み込み速度改善（主訴表示10倍高速化）
- [x] エラーハンドリングの実装

### ドキュメント作成
- [ ] 使用方法ガイドの作成
- [ ] 管理者向け設定ガイド
- [ ] デプロイ手順の更新

## 📦 Phase 7: デプロイ準備（2時間）

### 環境設定
- [ ] Render.comの環境変数設定
- [ ] 本番用APIキーの設定
- [ ] セキュリティ設定の確認

### 最終確認
- [ ] 全機能の動作確認
- [ ] レスポンシブデザインの確認
- [ ] クロスブラウザテスト

### リリース
- [ ] 本番環境へのデプロイ
- [ ] 動作確認
- [ ] クライアントへの納品準備

---

**総工数**: 55時間
**完了済み**: Phase 1-4, Phase 6の一部（約38時間）
**残り**: Phase 5, Phase 6-7の一部（約17時間）

**優先度**: 
- 🔴 高：Phase 1-3（基盤〜主訴別ペルソナ）✅ 完了
- 🟡 中：Phase 4-5（時系列分析〜競合分析）✅ Phase 4完了
- 🟢 低：Phase 6-7（テスト〜デプロイ）

**段階的実装の場合**:
- 第1段階：Phase 1-3（約20万円）✅ 完了
- 第2段階：Phase 4-5（約15万円）✅ Phase 4完了、Phase 5残

**追加実装内容**:
- キャッシュシステムによるパフォーマンス最適化 ✅ 完了
- XSS対策とセキュリティ強化 ✅ 完了
- スレッドセーフティ対応 ✅ 完了